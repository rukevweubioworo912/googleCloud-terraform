---
- name: Setup Docker Swarm
  hosts: webservers
  become: yes
  gather_facts: yes

  vars:
    manager_node: vm1
    manager_ip: "{{ hostvars['vm1']['ansible_host'] }}"

  tasks:
    - name: Check swarm state
      command: docker info --format '{{ "{{.Swarm.LocalNodeState}}" }}'
      register: swarm_state
      changed_when: false
      failed_when: false

    - name: Initialize swarm on manager
      command: docker swarm init --advertise-addr {{ manager_ip }}
      when:
        - inventory_hostname == manager_node
        - swarm_state.stdout != "active"

    - name: Get worker join token
      command: docker swarm join-token worker -q
      register: worker_token
      when: inventory_hostname == manager_node
      changed_when: false

    - name: Join swarm as worker
      command: >
        docker swarm join
        --token {{ hostvars[manager_node].worker_token.stdout }}
        {{ manager_ip }}:2377
      when:
        - inventory_hostname != manager_node
        - swarm_state.stdout != "active"
